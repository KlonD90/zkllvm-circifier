if(NOT LLVM_INCLUDE_TESTS)
    return()
endif()

include(ExternalProject)

set(EVM_TEST_SCRIPT ${CMAKE_CURRENT_SOURCE_DIR}/evm_test.rb)
set(EVMONE_BUILD_DIR ${CMAKE_BINARY_DIR}/evmone-build)
set(EVMONE_SOURCE_DIR ${CMAKE_BINARY_DIR}/evmone-source)

set(EVMONE_CMAKE_ARGS
    -DCMAKE_BUILD_TYPE=Debug
    -DEVMC_TOOLS=ON
    -DEVMONE_TESTING=OFF
    -DCMAKE_INSTALL_PREFIX=${EVMONE_BUILD_DIR}/install
    -DCMAKE_CXX_COMPILER=${CMAKE_CXX_COMPILER}
    -DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}
)

ExternalProject_Add(evmone
    GIT_REPOSITORY  https://github.com/NilFoundation/evmone.git
    GIT_TAG         2de80207495b3a05304962f6517691e979326ddc
    CONFIGURE_COMMAND ${CMAKE_COMMAND} <SOURCE_DIR> -G ${CMAKE_GENERATOR} ${EVMONE_CMAKE_ARGS}
    SOURCE_DIR      ${EVMONE_SOURCE_DIR}
    BINARY_DIR      ${EVMONE_BUILD_DIR}
    BUILD_COMMAND   ${CMAKE_COMMAND} --build ${EVMONE_BUILD_DIR} --target evmone evmc-tool
)
